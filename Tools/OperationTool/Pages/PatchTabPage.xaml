<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="OperationTool.Pages.PatchTabPage">
    
    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            EventName="Appearing"
            Command="{Binding ReloadCommand}" />
    </ContentPage.Behaviors>
    
    <ContentPage.Content>
         <Grid Padding="16" RowDefinitions="*">

            <Frame Padding="16"
                   BorderColor="{DynamicResource Gray300}"
                   BackgroundColor="{DynamicResource White}"
                   HasShadow="False"
                   HorizontalOptions="Fill"
                   VerticalOptions="Fill"
                   MaximumWidthRequest="980">

                <Grid RowSpacing="12"
                      RowDefinitions="Auto,Auto,*,Auto">

                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <Label Text="Latest Patch Version History"
                               FontAttributes="Bold"
                               FontSize="18"
                               VerticalTextAlignment="Center" />

                        <ActivityIndicator Grid.Column="1"
                                           IsRunning="{Binding IsBusy}"
                                           IsVisible="{Binding IsBusy}"
                                           VerticalOptions="Center" />
                    </Grid>

                    <Grid Grid.Row="1"
                          ColumnSpacing="12"
                          ColumnDefinitions="Auto,200">
                        <Label Grid.Column="0"
                               Text="Server Group Type:"
                               VerticalTextAlignment="Center" />

                        <Picker Grid.Column="1"
                                ItemsSource="{Binding ServerGroupTypes}"
                                SelectedItem="{Binding SelectedServerGroupType}" />
                    </Grid>

                    <Grid Grid.Row="2" RowDefinitions="Auto,*">
                        <Grid Grid.Row="0"
                              Padding="8,10"
                              ColumnSpacing="10"
                              ColumnDefinitions="160,110,90,*,160"
                              BackgroundColor="{DynamicResource Gray100}">
                            <Label Grid.Column="0" Text="Patch Version" FontAttributes="Bold" />
                            <Label Grid.Column="1" Text="Target Major" FontAttributes="Bold" />
                            <Label Grid.Column="2" Text="File ID" FontAttributes="Bold" />
                            <Label Grid.Column="3" Text="Comment" FontAttributes="Bold" />
                            <Label Grid.Column="4" Text="Created" FontAttributes="Bold" HorizontalTextAlignment="End" />
                        </Grid>

                        <CollectionView Grid.Row="1"
                                        Margin="0,6,0,0"
                                        ItemsSource="{Binding RefsPatchVersions}">
                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="0,20" Spacing="8" HorizontalOptions="Center">
                                    <Label Text="No data."
                                           FontAttributes="Bold"
                                           HorizontalTextAlignment="Center" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,6"
                                          ColumnSpacing="10"
                                          ColumnDefinitions="160,110,90,*,160">

                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup Name="CommonStates">
                                                <VisualState Name="Normal" />
                                                <VisualState Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="{DynamicResource Gray200}" />
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>

                                        <Label Grid.Column="0" Text="{Binding PatchVersion}" />
                                        <Label Grid.Column="1" Text="{Binding TargetMajor}" />
                                        <Label Grid.Column="2" Text="{Binding FileId}" />
                                        <Label Grid.Column="3" Text="{Binding Comment}" LineBreakMode="TailTruncation" />
                                        <Label Grid.Column="4"
                                               Text="{Binding CreatedUtcText}"
                                               HorizontalTextAlignment="End"
                                               LineBreakMode="NoWrap"
                                               Opacity="0.9" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>

                    <HorizontalStackLayout Grid.Row="3"
                                           Spacing="10"
                                           HorizontalOptions="End">

                        <Button Text="Generate .refs file"
                                Command="{Binding GoToGenerateRefsFileCommand}" />

                        <Button Text="Diff"
                                Command="{Binding GoToRefsDiffCommand}"/>

                        <Button Text="Patch"
                                Command="{Binding GoToPatchRefsFileCommand}"/>
                    </HorizontalStackLayout>

                </Grid>
            </Frame>
        </Grid>
    </ContentPage.Content>
</ContentPage>
